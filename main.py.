import telebot
from telebot import apihelper, types
import urllib.parse
import time

# =========================
# CONFIGURACIÃ“N
# =========================
TOKEN_TELEGRAM = "8441666201:AAHygO1Osx5IdxnmQpQuF__Y8WyGvBKhr4U"

apihelper.proxy = {'http': 'http://proxy.server:3128', 'https': 'http://proxy.server:3128'}
bot = telebot.TeleBot(TOKEN_TELEGRAM)

# =========================
# DICCIONARIO CON RUTAS REALES
# =========================
def generar_botones(query):
    q = urllib.parse.quote(query)
    markup = types.InlineKeyboardMarkup(row_width=2)

    # Lista de botones con sus URLs de bÃºsqueda reales 2026
    botones = [
        # EUROPA
        types.InlineKeyboardButton("ğŸ‡ªğŸ‡¸ Mercadona", url=f"https://tienda.mercadona.es{q}"),
        types.InlineKeyboardButton("ğŸ‡ªğŸ‡º LIDL", url=f"https://www.lidl.es{q}"),
        types.InlineKeyboardButton("ğŸ‡«ğŸ‡· Carrefour", url=f"https://www.carrefour.es{q}"),
        types.InlineKeyboardButton("ğŸ‡¬ğŸ‡§ Tesco", url=f"https://www.tesco.com{q}"),

        # AMÃ‰RICA / GLOBAL
        types.InlineKeyboardButton("ğŸ‡ºğŸ‡¸ Walmart", url=f"https://www.walmart.com{q}"),
        types.InlineKeyboardButton("ğŸŒ eBay", url=f"https://www.ebay.com{q}"),
        types.InlineKeyboardButton("ğŸ“¦ Amazon ES", url=f"https://www.amazon.es{q}"),
        types.InlineKeyboardButton("ğŸ‘— Vinted", url=f"https://www.vinted.es{q}"),
        types.InlineKeyboardButton("ğŸ‡¦ğŸ‡· Mercado Libre", url=f"https://lista.mercadolibre.com.ar{q}"),
        types.InlineKeyboardButton("ğŸ‡²ğŸ‡½ M. Libre MX", url=f"https://lista.mercadolibre.com.mx{q}")
    ]

    markup.add(*botones)
    return markup

# =========================
# LÃ“GICA DEL BOT
# =========================
@bot.message_handler(commands=['start'])
def send_welcome(message):
    msg = (
        "ğŸš€ *RADAR DE PRECIOS GLOBAL 2026*\n"
        "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n"
        "EnvÃ­ame el nombre de un producto y generarÃ© enlaces de bÃºsqueda directos para las tiendas mÃ¡s grandes del mundo."
    )
    bot.send_message(message.chat.id, msg, parse_mode="Markdown")

@bot.message_handler(func=lambda m: True)
def buscar(message):
    query = message.text.strip()
    if len(query) < 3:
        bot.reply_to(message, "âš ï¸ Escribe un nombre de producto mÃ¡s largo.")
        return

    msg_status = bot.reply_to(message, "ğŸ“¡ *Generando accesos directos...*", parse_mode="Markdown")

    # Generamos la botonera con las URLs corregidas
    markup = generar_botones(query)

    bot.edit_message_text(
        f"âœ… *Resultados para:* `{query.upper()}`\n\nToca una tienda para ver los precios actuales:",
        msg_status.chat.id,
        msg_status.message_id,
        reply_markup=markup,
        parse_mode="Markdown"
    )

if __name__ == "__main__":
    bot.infinity_polling(timeout=60)
